// ==UserScript==
// @name         Redmine Row Highlighter
// @namespace    http://tampermonkey.net/
// @version      0.2
// @description  Highlight rows with empty "Szállítói jegy [EKK]" column except "Nem hiba" status
// @match        https://projekt.nak.hu/projects/*/issues*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    function highlightEmptyRows() {
        const table = document.querySelector('table.list.issues');
        if (!table) return;

        const rows = table.querySelectorAll('tr.issue');
        const headers = Array.from(table.querySelectorAll('th'));

        // Find both required column indexes
        const supplierTicketColumnIndex = headers.findIndex(th => th.textContent.trim() === 'Szállítói jegy [EKK]');
        const statusColumnIndex = headers.findIndex(th => th.textContent.trim() === 'Státusz');

        if (supplierTicketColumnIndex === -1 || statusColumnIndex === -1) return;

        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length > Math.max(supplierTicketColumnIndex, statusColumnIndex)) {
                const supplierTicketCell = cells[supplierTicketColumnIndex];
                const statusCell = cells[statusColumnIndex];

                // Only highlight if supplier ticket is empty AND status is not "Nem hiba"
                if (supplierTicketCell.textContent.trim() === '' &&
                    statusCell.textContent.trim() !== 'Nem hiba') {
                    row.style.backgroundColor = 'yellow';
                } else {
                    // Remove highlighting if conditions are not met
                    row.style.backgroundColor = '';
                }
            }
        });
    }

    // Run the function when the page loads
    highlightEmptyRows();

    // Watch for changes in the DOM and re-run the function
    const observer = new MutationObserver(highlightEmptyRows);
    observer.observe(document.body, { childList: true, subtree: true });
})();
