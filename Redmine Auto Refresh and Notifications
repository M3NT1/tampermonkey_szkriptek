// ==UserScript==
// @name         Redmine Auto Refresh and Notifications
// @namespace    http://tampermonkey.net/
// @version      1.3
// @description  Automatic refresh and notifications for Redmine with persistent settings and notification management
// @author       M3NT1
// @match        https://projekt.nak.hu/*/issues*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    // Beállítások kezelése
    const Settings = {
        storageKey: 'redmineAutoRefreshSettings',
        notificationsKey: 'redmineNotifications',

        // Alapértelmezett beállítások
        defaults: {
            refreshInterval: 0,
            lastRefreshTime: null,
            notifications: []
        },

        // Beállítások betöltése
        load() {
            const stored = localStorage.getItem(this.storageKey);
            return stored ? JSON.parse(stored) : this.defaults;
        },

        // Beállítások mentése
        save(settings) {
            localStorage.setItem(this.storageKey, JSON.stringify(settings));
        },

        // Értesítések mentése
        saveNotification(notification) {
            const notifications = this.getNotifications();
            notifications.unshift({
                id: Date.now() + Math.random(), // Egyedi azonosító
                message: notification.message,
                type: notification.type,
                timestamp: new Date().getTime()
            });

            // Csak az utolsó 50 értesítést tároljuk
            if (notifications.length > 50) {
                notifications.pop();
            }

            localStorage.setItem(this.notificationsKey, JSON.stringify(notifications));
        },

        // Értesítések betöltése
        getNotifications() {
            const stored = localStorage.getItem(this.notificationsKey);
            return stored ? JSON.parse(stored) : [];
        },

        // Összes értesítés törlése
        clearAllNotifications() {
            localStorage.setItem(this.notificationsKey, JSON.stringify([]));
        },

        // Egy értesítés törlése
        deleteNotification(notificationId) {
            const notifications = this.getNotifications();
            const filteredNotifications = notifications.filter(n => n.id !== notificationId);
            localStorage.setItem(this.notificationsKey, JSON.stringify(filteredNotifications));
        }
    };

    // Stílusok hozzáadása
    const style = document.createElement('style');
    style.textContent = `
        .notification-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 300px;
            z-index: 9999;
        }
        .notification {
            background: #fff;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            animation: slideIn 0.5s ease-out;
        }
        .notification.success { border-left: 4px solid #28a745; }
        .notification.warning { border-left: 4px solid #ffc107; }
        .notification.error { border-left: 4px solid #dc3545; }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .auto-refresh-controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #fff;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            max-width: 400px;
        }

        .notification-history {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
            font-size: 12px;
        }

        .notification-history-item {
            padding: 5px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-history-item .delete-btn {
            cursor: pointer;
            color: #dc3545;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }

        .notification-history-item .delete-btn:hover {
            background-color: #dc3545;
            color: white;
        }

        .notification-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding: 5px 0;
            border-top: 1px solid #eee;
        }

        .btn {
            padding: 5px 10px;
            border-radius: 3px;
            border: none;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }
    `;
    document.head.appendChild(style);

    let refreshInterval;
    let lastUpdate = {};

    // Értesítési panel létrehozása
    function createNotificationPanel() {
        const panel = document.createElement('div');
        panel.className = 'notification-panel';
        document.body.appendChild(panel);
        return panel;
    }

    // Automatikus frissítés vezérlő létrehozása
    function createRefreshControls() {
        const controls = document.createElement('div');
        controls.className = 'auto-refresh-controls';

        const settings = Settings.load();

        controls.innerHTML = `
            <label>
                Auto frissítés:
                <select id="refresh-interval">
                    <option value="0" ${settings.refreshInterval === 0 ? 'selected' : ''}>Ki</option>
                    <option value="30" ${settings.refreshInterval === 30 ? 'selected' : ''}>30 mp</option>
                    <option value="60" ${settings.refreshInterval === 60 ? 'selected' : ''}>1 perc</option>
                    <option value="300" ${settings.refreshInterval === 300 ? 'selected' : ''}>5 perc</option>
                </select>
            </label>
            <div id="last-refresh">Utolsó frissítés: ${settings.lastRefreshTime ? new Date(settings.lastRefreshTime).toLocaleTimeString() : 'soha'}</div>
            <div class="notification-controls">
                <button id="show-notifications" class="btn btn-primary">Értesítések mutatása</button>
                <button id="clear-all-notifications" class="btn btn-danger">Összes értesítés törlése</button>
            </div>
            <div class="notification-history" style="display: none;"></div>
        `;

        document.body.appendChild(controls);

        // Eseménykezelők hozzáadása
        document.getElementById('refresh-interval').addEventListener('change', (e) => {
            const interval = parseInt(e.target.value);
            if (interval > 0) {
                startAutoRefresh(interval);
            } else {
                stopAutoRefresh();
            }

            // Beállítások mentése
            const settings = Settings.load();
            settings.refreshInterval = interval;
            Settings.save(settings);
        });

        document.getElementById('show-notifications').addEventListener('click', toggleNotificationHistory);

        document.getElementById('clear-all-notifications').addEventListener('click', () => {
            if (confirm('Biztosan törölni szeretnéd az összes értesítést?')) {
                Settings.clearAllNotifications();
                updateNotificationHistory();
                showNotification('Összes értesítés törölve', 'success', false);
            }
        });

        // Ha volt korábban beállított intervallum, indítsuk újra
        if (settings.refreshInterval > 0) {
            startAutoRefresh(settings.refreshInterval);
        }
    }

    // Értesítések előzmények megjelenítése/elrejtése
    function toggleNotificationHistory() {
        const historyDiv = document.querySelector('.notification-history');
        const showNotificationsBtn = document.getElementById('show-notifications');
        if (historyDiv.style.display === 'none') {
            historyDiv.style.display = 'block';
            showNotificationsBtn.textContent = 'Értesítések elrejtése';
            updateNotificationHistory();
        } else {
            historyDiv.style.display = 'none';
            showNotificationsBtn.textContent = 'Értesítések mutatása';
        }
    }

    // Értesítések előzmények frissítése
    function updateNotificationHistory() {
        const historyDiv = document.querySelector('.notification-history');
        const notifications = Settings.getNotifications();

        historyDiv.innerHTML = notifications.map(notification => `
            <div class="notification-history-item ${notification.type}">
                <span>${new Date(notification.timestamp).toLocaleString()} - ${notification.message}</span>
                <span class="delete-btn" data-id="${notification.id}">×</span>
            </div>
        `).join('');

        // Törlés gombok eseménykezelőinek hozzáadása
        historyDiv.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const notificationId = parseFloat(e.target.dataset.id);
                Settings.deleteNotification(notificationId);
                updateNotificationHistory();
                showNotification('Értesítés törölve', 'success', false);
            });
        });
    }

    // Értesítés megjelenítése
    function showNotification(message, type = 'success', store = true) {
        const panel = document.querySelector('.notification-panel') || createNotificationPanel();

        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;

        panel.appendChild(notification);

        // Csak akkor tároljuk, ha a store paraméter true
        if (store) {
            Settings.saveNotification({ message, type });
            updateNotificationHistory();
        }

        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 500);
        }, 5000);
    }

    // Automatikus frissítés indítása
    function startAutoRefresh(seconds) {
        stopAutoRefresh();
        refreshInterval = setInterval(checkForUpdates, seconds * 1000);
        updateLastRefreshTime();
    }

    // Automatikus frissítés leállítása
    function stopAutoRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
            refreshInterval = null;
        }
    }

    // Frissítési idő frissítése
    function updateLastRefreshTime() {
        const currentTime = new Date().getTime();
        const lastRefreshElement = document.getElementById('last-refresh');
        if (lastRefreshElement) {
            lastRefreshElement.textContent = `Utolsó frissítés: ${new Date(currentTime).toLocaleTimeString()}`;
        }

        // Mentés a beállításokba
        const settings = Settings.load();
        settings.lastRefreshTime = currentTime;
        Settings.save(settings);
    }

    // Változások ellenőrzése
    function checkForUpdates() {
        fetch(window.location.href)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Issue változások ellenőrzése
                if (window.location.pathname.includes('/issues')) {
                    checkIssueChanges(doc);
                }

                updateLastRefreshTime();
            });
    }

    // Issue változások ellenőrzése
    function checkIssueChanges(newDoc) {
        const currentIssues = Array.from(document.querySelectorAll('tr.issue')).map(row => ({
            id: row.getAttribute('id'),
            status: row.querySelector('td.status')?.textContent,
            priority: row.querySelector('td.priority')?.textContent
        }));

        const newIssues = Array.from(newDoc.querySelectorAll('tr.issue')).map(row => ({
            id: row.getAttribute('id'),
            status: row.querySelector('td.status')?.textContent,
            priority: row.querySelector('td.priority')?.textContent
        }));

        // Változások keresése
        currentIssues.forEach(current => {
            const newIssue = newIssues.find(issue => issue.id === current.id);
            if (newIssue) {
                if (newIssue.status !== current.status) {
                    showNotification(`Státusz változás: ${current.id} - ${newIssue.status}`, 'warning');
                }
                if (newIssue.priority !== current.priority) {
                    showNotification(`Prioritás változás: ${current.id} - ${newIssue.priority}`, 'warning');
                }
            }
        });

        // Új issue-k keresése
        const newIssueIds = newIssues.map(issue => issue.id);
        const currentIssueIds = currentIssues.map(issue => issue.id);
        const addedIssues = newIssueIds.filter(id => !currentIssueIds.includes(id));

        if (addedIssues.length > 0) {
            showNotification(`${addedIssues.length} új feladat érkezett`, 'success');
            window.location.reload();
        }
    }

    // Szkript inicializálása
    createRefreshControls();

    // Kezdeti értesítés
    showNotification('Automatikus frissítés aktív', 'success', false);

})();
